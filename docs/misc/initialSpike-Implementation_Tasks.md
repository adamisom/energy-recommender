# Implementation Tasks - Energy Plan Recommender

This document breaks down the PRD into actionable tasks with file-level granularity. Each task lists:
- Files to create
- Files to modify
- Dependencies (what must be done first)
- Commands to run
- Tests to verify

---

## Phase 0: Project Setup

### Task 0.1: Create Next.js Project

**Files to create:**
- (All files generated by `create-next-app`)

**Files to modify:**
- None

**Dependencies:**
- None

**Commands:**
```bash
npx create-next-app@latest energy-recommender --typescript --tailwind --app
cd energy-recommender
```

**Answer prompts:**
- ✅ TypeScript
- ✅ ESLint  
- ✅ Tailwind CSS
- ❌ `src/` directory (keep it simple)
- ✅ App Router (NOT Pages Router)
- ✅ Import alias `@/*`

**Tests:**
- [ ] `npm run dev` starts on http://localhost:3000
- [ ] Can access Next.js welcome page

---

### Task 0.2: Install Core Dependencies

**Files to create:**
- None

**Files to modify:**
- `package.json` (updated by npm install)

**Dependencies:**
- Task 0.1

**Commands:**
```bash
npm install @anthropic-ai/sdk @supabase/supabase-js zod react-hook-form @hookform/resolvers
npm install -D prisma
npx prisma init
```

**Tests:**
- [ ] `package.json` includes all dependencies
- [ ] `prisma/` directory exists with `schema.prisma`

---

### Task 0.3: Install shadcn/ui Components

**Files to create:**
- `components.json` (generated by shadcn init)
- `components/ui/` directory (created by shadcn)

**Files to modify:**
- `tailwind.config.ts` (updated by shadcn)
- `app/globals.css` (updated by shadcn)

**Dependencies:**
- Task 0.1

**Commands:**
```bash
npx shadcn-ui@latest init
# Answer prompts: Style: Default, Base color: Slate, CSS variables: Yes

npx shadcn-ui@latest add button card input label select table badge dialog slider radio-group tabs
```

**Tests:**
- [ ] `components/ui/` directory exists
- [ ] Can import components: `import { Button } from '@/components/ui/button'`
- [ ] No TypeScript errors

---

### Task 0.4: Configure Environment Variables

**Files to create:**
- `.env.local`

**Files to modify:**
- `.gitignore` (should already include `.env.local`)

**Dependencies:**
- Task 0.1
- Supabase account created

**Commands:**
```bash
# Create .env.local file
touch .env.local
```

**Content for `.env.local`:**
```bash
# Anthropic API
ANTHROPIC_API_KEY=sk-ant-xxxxx

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.xxxxx.supabase.co:5432/postgres

# Feature Flags (optional)
ENABLE_SEASONAL_SCORING=false
```

**Tests:**
- [ ] `.env.local` exists
- [ ] `.env.local` is in `.gitignore`
- [ ] Can access env vars: `process.env.ANTHROPIC_API_KEY`

---

### Task 0.5: Create Project Structure

**Files to create:**
- `app/api/recommendations/` (directory)
- `app/api/plans/` (directory)
- `lib/actions/` (directory)
- `lib/scoring/` (directory)
- `lib/database/` (directory)
- `lib/anthropic/` (directory)
- `lib/auth/` (directory)
- `components/forms/` (directory)
- `components/recommendations/` (directory)
- `types/` (directory)

**Files to modify:**
- None

**Dependencies:**
- Task 0.1

**Commands:**
```bash
mkdir -p app/api/recommendations
mkdir -p app/api/plans
mkdir -p lib/{actions,scoring,database,anthropic,auth}
mkdir -p components/{ui,forms,recommendations}
mkdir -p types
```

**Tests:**
- [ ] All directories exist
- [ ] Directory structure matches PRD

---

### Task 0.6: Configure Prisma Schema

**Files to create:**
- None (schema.prisma already exists from `prisma init`)

**Files to modify:**
- `prisma/schema.prisma`

**Dependencies:**
- Task 0.2

**Content:** See PRD Phase 0.6 for full schema

**Commands:**
```bash
npx prisma db push
npx prisma generate
```

**Tests:**
- [ ] `npx prisma studio` opens database browser
- [ ] No Prisma errors
- [ ] `@prisma/client` can be imported

---

### Task 0.7: Push Schema to Supabase

**Files to create:**
- None

**Files to modify:**
- None

**Dependencies:**
- Task 0.4 (DATABASE_URL configured)
- Task 0.6 (schema.prisma configured)

**Commands:**
```bash
npx prisma db push
npx prisma generate
```

**Tests:**
- [ ] Schema pushed to Supabase
- [ ] Can see Plan and User tables in Supabase dashboard
- [ ] Prisma Client generated successfully

---

### Task 0.8: Set Up Authentication (OPTIONAL FOR MVP)

**Files to create:**
- `lib/auth/client.ts`
- `lib/auth/server.ts`
- `app/auth/login/page.tsx` (if implementing)
- `app/auth/signup/page.tsx` (if implementing)
- `app/auth/callback/route.ts` (if implementing)

**Files to modify:**
- None

**Dependencies:**
- Task 0.2 (Supabase installed)
- Task 0.4 (Supabase env vars)

**Note:** Auth is optional for MVP. Can skip and use sessionStorage instead.

**Tests:**
- [ ] Supabase client can be imported
- [ ] Server client works in API routes

---

### Task 0.9: Initialize Git

**Files to create:**
- `.gitignore` (should already exist)

**Files to modify:**
- None

**Dependencies:**
- All previous tasks

**Commands:**
```bash
git init
git add .
git commit -m "Initial commit: Energy Plan Recommender"
```

**Tests:**
- [ ] `.gitignore` includes `.env.local`
- [ ] No sensitive files committed

---

## Phase 1: Data Models & Database Setup

### Task 1.1: Define TypeScript Types

**Files to create:**
- `types/index.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 0.5 (types directory exists)

**Content:** See PRD Phase 1.1 for full type definitions

**Tests:**
- [ ] Can import types: `import { Plan } from '@/types'`
- [ ] No TypeScript errors
- [ ] All types match Prisma schema

---

### Task 1.2: Create Database Client

**Files to create:**
- `lib/database/client.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 0.6 (Prisma configured)
- Task 1.1 (types defined)

**Content:** See PRD Phase 1.2

**Tests:**
- [ ] Can import: `import { prisma } from '@/lib/database/client'`
- [ ] Can query: `await prisma.plan.findMany()`
- [ ] No connection errors

---

### Task 1.3: Create Sample Plan Data

**Files to create:**
- `prisma/seed.ts`

**Files to modify:**
- `package.json` (add seed script)

**Dependencies:**
- Task 1.2 (database client)
- Task 0.6 (schema)

**Content:** See PRD Phase 1.3 for sample plans

**Commands:**
```bash
npm install -D tsx
# Add to package.json scripts: "seed": "tsx prisma/seed.ts"
npm run seed
```

**Tests:**
- [ ] `npm run seed` runs successfully
- [ ] Plans appear in database (check with Prisma Studio)
- [ ] At least 20 plans seeded (15-17 TX, 1-2 each PA/OH/IL)

---

### Task 1.4: Download RECS Data (Optional)

**Files to create:**
- `data/recs/` (directory)
- `data/recs/monthly_consumption.csv` (downloaded file)

**Files to modify:**
- None

**Dependencies:**
- None

**Commands:**
```bash
mkdir -p data/recs
# Download from https://www.eia.gov/consumption/residential/data/2020/
# Save to data/recs/monthly_consumption.csv
```

**Tests:**
- [ ] CSV file exists
- [ ] File has 12+ columns (household ID + 12 months)

---

### Task 1.5: Create RECS Parser

**Files to create:**
- `lib/database/recs-parser.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.4 (RECS data downloaded)

**Content:** See PRD Phase 1.7

**Tests:**
- [ ] Can parse RECS file
- [ ] Returns valid household data
- [ ] Filters out invalid entries

---

## Phase 2: Core Recommendation Logic

### Task 2.1: Usage Analysis Service

**Files to create:**
- `lib/scoring/usage-analysis.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.1 (types)

**Content:** See PRD Phase 2.1

**Tests:**
- [ ] `analyzeUsage([...12 months])` works
- [ ] Correctly identifies summer_peak pattern
- [ ] Throws error for invalid input (< 12 months)

---

### Task 2.2: Cost Calculation Engine

**Files to create:**
- `lib/scoring/cost-calculator.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.1 (Plan type)
- Task 2.1 (usage analysis)

**Content:** See PRD Phase 2.2

**Tests:**
- [ ] Fixed-rate calculation matches manual math
- [ ] TOU calculation applies on-peak/off-peak split
- [ ] Early termination fee included when applicable

---

### Task 2.3: Plan Scoring Algorithm

**Files to create:**
- `lib/scoring/plan-scorer.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 2.1 (UsagePattern)
- Task 2.2 (CostBreakdown)
- Task 1.1 (Plan, UserPreferences)

**Content:** See PRD Phase 2.3

**Tests:**
- [ ] Cost-priority user gets cheapest plan ranked #1
- [ ] Renewable-priority user gets highest % renewable #1
- [ ] Seasonal scoring feature flag works (on/off)
- [ ] Edge case: all plans same cost doesn't crash

---

### Task 2.4: Plan Filtering & Ranking

**Files to create:**
- `lib/scoring/plan-ranker.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 2.1, 2.2, 2.3 (all scoring modules)

**Content:** See PRD Phase 2.4

**Tests:**
- [ ] Filters plans by user constraints
- [ ] Relaxes constraints if < 3 plans found
- [ ] Returns top 3 plans sorted by score

---

## Phase 3: LLM Explanation Generation

### Task 3.1: Configure Anthropic Client

**Files to create:**
- `lib/anthropic/client.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 0.4 (ANTHROPIC_API_KEY env var)

**Content:** See PRD Phase 3.1

**Tests:**
- [ ] Can import anthropic client
- [ ] No API key errors

---

### Task 3.2: Create Explanation Generator

**Files to create:**
- `lib/anthropic/explanations.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 3.1 (Anthropic client)
- Task 1.1 (types)
- Task 2.1 (UsagePattern)
- Task 2.2 (CostBreakdown)

**Content:** See PRD Phase 3.2

**Tests:**
- [ ] Generates explanation for test plan
- [ ] Falls back to template on API error
- [ ] Cache works (second call returns cached)
- [ ] Timeout works (10 seconds)

---

### Task 3.3: Batch Explanation Generation

**Files to create:**
- `lib/anthropic/batch-explanations.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 3.2 (explanation generator)
- Task 2.3 (ScoredPlan)

**Content:** See PRD Phase 3.3

**Tests:**
- [ ] Generates 3 explanations in parallel
- [ ] All explanations returned successfully

---

## Phase 4: API Routes

### Task 4.0: Create Rate Limiting Utility

**Files to create:**
- `lib/rate-limit.ts`

**Files to modify:**
- None

**Dependencies:**
- None

**Content:** See PRD Phase 4.0

**Tests:**
- [ ] Rate limit allows 10 requests/minute
- [ ] Returns 429 after limit exceeded
- [ ] Resets after window expires

---

### Task 4.1: Create Recommendations API Route

**Files to create:**
- `app/api/recommendations/route.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.2 (prisma client)
- Task 2.1, 2.2, 2.3, 2.4 (all scoring)
- Task 3.3 (batch explanations)
- Task 4.0 (rate limiting)

**Content:** See PRD Phase 4.1

**Tests:**
- [ ] POST with valid data returns 200 with 3 recommendations
- [ ] POST with invalid data returns 400
- [ ] Rate limiting works (429 after 10 requests)
- [ ] State filtering works
- [ ] Returns < 2 seconds

---

### Task 4.2: Create Plans API Route

**Files to create:**
- `app/api/plans/route.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.2 (prisma client)

**Content:** See PRD Phase 4.2

**Tests:**
- [ ] GET returns all plans
- [ ] GET with filters works (minRenewable, maxContract, etc.)
- [ ] Search works

---

### Task 4.3: Create Plan Details API Route

**Files to create:**
- `app/api/plans/[id]/route.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 1.2 (prisma client)

**Content:** See PRD Phase 4.3

**Tests:**
- [ ] GET with valid ID returns plan
- [ ] GET with invalid ID returns 404

---

## Phase 5: Frontend Pages & Components

### Task 5.1: Landing Page

**Files to create:**
- `app/page.tsx` (replace default)

**Files to modify:**
- None

**Dependencies:**
- Task 0.3 (shadcn components)

**Content:** See PRD Phase 5.1

**Tests:**
- [ ] Page loads at `/`
- [ ] "Get Started" button links to `/usage`
- [ ] Responsive on mobile

---

### Task 5.2: Usage Input Page

**Files to create:**
- `app/usage/page.tsx`

**Files to modify:**
- None

**Dependencies:**
- Task 0.3 (shadcn components)

**Content:** See PRD Phase 5.2

**Tests:**
- [ ] Manual entry works (12 inputs)
- [ ] CSV upload parses correctly
- [ ] Validation works (all months > 0)
- [ ] Stores data in sessionStorage
- [ ] "Next" button disabled until valid

---

### Task 5.3: Preferences Page

**Files to create:**
- `app/preferences/page.tsx`

**Files to modify:**
- None

**Dependencies:**
- Task 5.2 (usage data in sessionStorage)
- Task 0.3 (shadcn components)

**Content:** See PRD Phase 5.3

**Tests:**
- [ ] State selection works
- [ ] Priority selection works (4 options)
- [ ] Advanced filters work (sliders)
- [ ] Stores preferences in sessionStorage
- [ ] Redirects to /usage if no usage data

---

### Task 5.4: Recommendations Page

**Files to create:**
- `app/recommendations/page.tsx`

**Files to modify:**
- None

**Dependencies:**
- Task 4.1 (API route)
- Task 5.3 (preferences)
- Task 0.3 (shadcn components)

**Content:** See PRD Phase 5.4

**Tests:**
- [ ] Shows loading state
- [ ] Displays 3 recommendations
- [ ] Shows explanations
- [ ] Handles API errors gracefully
- [ ] Handles 429 rate limit error
- [ ] "View Details" links work

---

### Task 5.5: Plan Details Page

**Files to create:**
- `app/plan/[id]/page.tsx`

**Files to modify:**
- None

**Dependencies:**
- Task 4.3 (plan details API)
- Task 0.3 (shadcn components)

**Content:** See PRD Phase 5.5

**Tests:**
- [ ] Shows plan details
- [ ] 404 for invalid plan ID
- [ ] Sign Up button shows modal
- [ ] Back button works

---

### Task 5.6: Sign Up Modal Component

**Files to create:**
- `components/recommendations/sign-up-button.tsx` (optional - can be inline)

**Files to modify:**
- `app/recommendations/page.tsx` (add SignUpButton component)
- `app/plan/[id]/page.tsx` (add SignUpButton component)

**Dependencies:**
- Task 0.3 (Dialog component)

**Content:** See PRD Phase 5.4 and 5.5

**Tests:**
- [ ] Modal opens on button click
- [ ] Shows MVP message
- [ ] Can close modal

---

## Phase 6: Testing

### Task 6.1: Unit Tests Setup

**Files to create:**
- `__tests__/` (directory)
- `jest.config.js` or `vitest.config.ts`
- `__tests__/scoring/usage-analysis.test.ts`
- `__tests__/scoring/cost-calculator.test.ts`
- `__tests__/scoring/plan-scorer.test.ts`

**Files to modify:**
- `package.json` (add test script)

**Dependencies:**
- All Phase 2 tasks

**Commands:**
```bash
npm install -D jest @testing-library/react @testing-library/jest-dom
# or
npm install -D vitest @vitest/ui
```

**Tests:**
- [ ] All unit tests pass
- [ ] Test coverage > 80% for scoring logic

---

### Task 6.2: API Route Tests

**Files to create:**
- `__tests__/api/recommendations.test.ts`
- `__tests__/api/plans.test.ts`

**Files to modify:**
- None

**Dependencies:**
- Task 4.1, 4.2, 4.3 (API routes)

**Tests:**
- [ ] API tests pass
- [ ] Rate limiting tested

---

### Task 6.3: E2E Tests Setup

**Files to create:**
- `tests/e2e/` (directory)
- `tests/e2e/happy-path.spec.ts`
- `playwright.config.ts`

**Files to modify:**
- `package.json` (add playwright script)

**Dependencies:**
- All Phase 5 tasks (frontend complete)

**Commands:**
```bash
npm install -D @playwright/test
npx playwright install
```

**Tests:**
- [ ] E2E tests pass
- [ ] Tests full user flow

---

### Task 6.4: Accessibility Testing

**Files to create:**
- None

**Files to modify:**
- None

**Dependencies:**
- All Phase 5 tasks

**Commands:**
```bash
npm install -D @lighthouse/cli
npx lighthouse http://localhost:3000 --view
```

**Tests:**
- [ ] Lighthouse accessibility score ≥90
- [ ] All images have alt text
- [ ] Keyboard navigation works

---

## Phase 7: Deployment

### Task 7.1: Prepare for Production

**Files to create:**
- None

**Files to modify:**
- None

**Dependencies:**
- All previous phases

**Commands:**
```bash
npm run build
npm start
```

**Tests:**
- [ ] Production build succeeds
- [ ] No build errors
- [ ] Production build runs locally

---

### Task 7.2: Deploy to Vercel

**Files to create:**
- `vercel.json` (optional)

**Files to modify:**
- None

**Dependencies:**
- Task 7.1 (build works)
- GitHub repository (if using GitHub integration)

**Commands:**
```bash
npm install -g vercel
vercel login
vercel --prod
```

**Or via GitHub:**
1. Push to GitHub
2. Import in Vercel dashboard
3. Auto-deploys on push

**Tests:**
- [ ] Site accessible via HTTPS
- [ ] All pages load
- [ ] API routes work

---

### Task 7.3: Configure Environment Variables

**Files to create:**
- None

**Files to modify:**
- Vercel dashboard (env vars)

**Dependencies:**
- Task 7.2 (Vercel project created)

**Environment Variables to Set:**
- `ANTHROPIC_API_KEY`
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `DATABASE_URL`
- `ENABLE_SEASONAL_SCORING` (optional)

**Tests:**
- [ ] All env vars set in Vercel
- [ ] API calls work in production
- [ ] Database connections work

---

### Task 7.4: Set up Production Database

**Files to create:**
- None

**Files to modify:**
- None

**Dependencies:**
- Task 7.3 (DATABASE_URL configured)
- Supabase production project

**Commands:**
```bash
# With production DATABASE_URL
npx prisma db push
npm run seed
```

**Tests:**
- [ ] Production database has plans
- [ ] Can query production database
- [ ] Schema matches dev

---

## Quick Reference: File Structure

```
energy-recommender/
├── app/
│   ├── page.tsx                    # Landing (Task 5.1)
│   ├── usage/page.tsx              # Usage input (Task 5.2)
│   ├── preferences/page.tsx        # Preferences (Task 5.3)
│   ├── recommendations/page.tsx    # Results (Task 5.4)
│   ├── plan/[id]/page.tsx          # Plan details (Task 5.5)
│   ├── auth/                       # Auth pages (Task 0.8, optional)
│   └── api/
│       ├── recommendations/route.ts    # API (Task 4.1)
│       └── plans/
│           ├── route.ts            # Plans list (Task 4.2)
│           └── [id]/route.ts       # Plan details API (Task 4.3)
├── components/
│   ├── ui/                         # shadcn components (Task 0.3)
│   ├── forms/                      # Form components (future)
│   └── recommendations/            # Result components (Task 5.6)
├── lib/
│   ├── actions/                    # Server actions (future)
│   ├── scoring/
│   │   ├── usage-analysis.ts       # Task 2.1
│   │   ├── cost-calculator.ts      # Task 2.2
│   │   ├── plan-scorer.ts          # Task 2.3
│   │   └── plan-ranker.ts          # Task 2.4
│   ├── database/
│   │   ├── client.ts               # Task 1.2
│   │   └── recs-parser.ts          # Task 1.5
│   ├── anthropic/
│   │   ├── client.ts               # Task 3.1
│   │   ├── explanations.ts         # Task 3.2
│   │   └── batch-explanations.ts   # Task 3.3
│   ├── auth/                       # Auth (Task 0.8, optional)
│   └── rate-limit.ts               # Task 4.0
├── types/
│   └── index.ts                    # Task 1.1
├── prisma/
│   ├── schema.prisma               # Task 0.6
│   └── seed.ts                     # Task 1.3
├── __tests__/                      # Tests (Phase 6)
├── tests/
│   └── e2e/                        # E2E tests (Task 6.3)
└── data/
    └── recs/                       # RECS data (Task 1.4)
```

---

## Dependency Graph

```
Phase 0 (Setup)
  └─> Phase 1 (Data Models)
      └─> Phase 2 (Core Logic)
          └─> Phase 3 (LLM)
              └─> Phase 4 (API Routes)
                  └─> Phase 5 (Frontend)
                      └─> Phase 6 (Testing)
                          └─> Phase 7 (Deployment)
```

**Critical Path:**
1. Setup (0.1-0.9) → 2. Data Models (1.1-1.5) → 3. Core Logic (2.1-2.4) → 4. LLM (3.1-3.3) → 5. API (4.0-4.3) → 6. Frontend (5.1-5.6) → 7. Testing & Deploy (6-7)

---

## Estimated Time per Task

| Task | Estimated Time | Notes |
|------|---------------|-------|
| 0.1-0.9 | 30-45 min | Setup is quick |
| 1.1-1.5 | 3-4 hours | Data modeling |
| 2.1-2.4 | 6-8 hours | Core algorithm |
| 3.1-3.3 | 3-4 hours | LLM integration |
| 4.0-4.3 | 2-3 hours | API routes |
| 5.1-5.6 | 10-14 hours | Frontend pages |
| 6.1-6.4 | 4-5 hours | Testing |
| 7.1-7.4 | 2-3 hours | Deployment |

**Total: 31-44 hours**

