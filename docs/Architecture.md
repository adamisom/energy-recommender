# AI Energy Plan Recommender - System Architecture

## Table of Contents
1. [System Overview](#system-overview)
2. [Architecture Diagram](#architecture-diagram)
3. [Component Architecture](#component-architecture)
4. [Data Flow Diagrams](#data-flow-diagrams)
5. [AI Integration Points](#ai-integration-points)
6. [Client-Server Interactions](#client-server-interactions)
7. [Database Schema](#database-schema)
8. [API Architecture](#api-architecture)
9. [Error Handling Flows](#error-handling-flows)

---

## System Overview

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Next.js Application                       â”‚
â”‚                     (Single Full-Stack Codebase)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Client (Browser)  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Server (Vercel)     â”‚       â”‚
â”‚  â”‚  - React Components â”‚         â”‚  - API Routes        â”‚       â”‚
â”‚  â”‚  - State Management â”‚         â”‚  - Business Logic    â”‚       â”‚
â”‚  â”‚  - Form Validation  â”‚         â”‚  - AI Integration    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                            â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â”‚                        â”‚
                    â–¼                        â–¼                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Supabase    â”‚      â”‚  Anthropic API  â”‚    â”‚  External Data   â”‚
            â”‚  (PostgreSQL) â”‚      â”‚    (Claude)     â”‚    â”‚  PowerToChoose   â”‚
            â”‚   - Plans DB  â”‚      â”‚  - Explanations â”‚    â”‚  (Manual/Scrape) â”‚
            â”‚   - User DB   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| **Frontend** | React 18 (Server Components) | UI rendering |
| **Routing** | Next.js App Router | Page routing, layouts |
| **Styling** | Tailwind CSS + shadcn/ui | Component styling |
| **Backend** | Next.js API Routes | REST API endpoints |
| **Database** | Supabase (PostgreSQL) | Plan catalog storage |
| **ORM** | Prisma | Type-safe database access |
| **AI** | Anthropic Claude API | Explanation generation |
| **Validation** | Zod | Runtime type validation |
| **Auth** | Supabase Auth (optional) | User authentication |
| **Deployment** | Vercel | Serverless hosting |

---

## Architecture Diagram

### Full System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER BROWSER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Landing     â”‚  â”‚   Usage      â”‚  â”‚ Preferences  â”‚  â”‚ Results    â”‚ â”‚
â”‚  â”‚  Page        â”‚â”€>â”‚   Input      â”‚â”€>â”‚   Page       â”‚â”€>â”‚  Page      â”‚ â”‚
â”‚  â”‚  (/)         â”‚  â”‚  (/usage)    â”‚  â”‚(/preferences)â”‚  â”‚(/recommend)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚          â”‚
â”‚                          sessionStorage                       â”‚          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚          â”‚
â”‚                    â”‚ - usageData        â”‚                    â”‚          â”‚
â”‚                    â”‚ - preferences      â”‚                    â”‚          â”‚
â”‚                    â”‚ - state            â”‚                    â”‚          â”‚
â”‚                    â”‚ - currentPlan      â”‚                    â”‚          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚          â”‚
â”‚                                                               â”‚          â”‚
â”‚                          localStorage                        â”‚          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚          â”‚
â”‚                    â”‚ - viewedPlans      â”‚                    â”‚          â”‚
â”‚                    â”‚ - favoritePlans   â”‚                    â”‚          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚          â”‚
â”‚                                                               â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                                       POST /api/recommendations
                                                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          VERCEL EDGE NETWORK                   â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              API Route: /api/recommendations                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ 1. Rate Limiting (IP-based)                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 2. Request Validation (Zod)                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 3. Fetch Plans (Prisma â†’ Supabase)                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 4. Analyze Usage Patterns                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 5. Calculate Costs (all plans)                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 6. Score Plans (custom algorithm)                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 7. Rank & Filter (top 5)                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 8. Generate Explanations (AI) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 9. Build Response                        â”‚                 â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                   â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Business Logic Layer                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚   Scoring    â”‚  â”‚     Cost     â”‚  â”‚    Usage Analysis        â”‚â”‚ â”‚
â”‚  â”‚  â”‚   Engine     â”‚  â”‚  Calculator  â”‚  â”‚  (pattern detection)     â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                   â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                       â”‚                   â”‚
                            â–¼                       â–¼                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Supabase    â”‚    â”‚  Anthropic API   â”‚  â”‚   Cache     â”‚
                    â”‚  (PostgreSQL) â”‚    â”‚  (Claude 3.5)    â”‚  â”‚ (In-Memory) â”‚
                    â”‚               â”‚    â”‚                  â”‚  â”‚ - LLM resp  â”‚
                    â”‚  Tables:      â”‚    â”‚  Model:          â”‚  â”‚ - Rate lim  â”‚
                    â”‚  - plans      â”‚    â”‚  Sonnet 4        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  - users      â”‚    â”‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Architecture

### Frontend Components (Client-Side)

```
app/
â”œâ”€â”€ page.tsx (Server Component)
â”‚   â””â”€â”€ Landing Page
â”‚       - Hero section
â”‚       - How it works
â”‚       - CTA button
â”‚
â”œâ”€â”€ usage/page.tsx (Client Component)
â”‚   â””â”€â”€ Usage Input Form
â”‚       - Manual entry (12 inputs)
â”‚       - CSV upload (papaparse)
â”‚       - Validation
â”‚       â””â”€> sessionStorage
â”‚
â”œâ”€â”€ preferences/page.tsx (Client Component)
â”‚   â””â”€â”€ Preferences Form
â”‚       - State selection
â”‚       - Priority selection
â”‚       - Advanced filters (sliders)
â”‚       - Current plan (optional)
â”‚       â””â”€> sessionStorage
â”‚
â”œâ”€â”€ recommendations/page.tsx (Client Component)
â”‚   â””â”€â”€ Results Display
â”‚       - Loading state
â”‚       - Top 5 cards
â”‚       - Search & filter (name/supplier, hide viewed)
â”‚       - Favorites/bookmarks (max 5)
â”‚       - Compare plans (2 at once)
â”‚       - AI explanations
â”‚       - Sign up buttons
â”‚       â””â”€> API call
â”‚
â”œâ”€â”€ recommendations/history/page.tsx (Client Component)
â”‚   â””â”€â”€ Recommendation History
â”‚       - Last 5 recommendation sets
â”‚       - Preferences used
â”‚       - Top 3 plans per set
â”‚
â”œâ”€â”€ recommendations/favorites/page.tsx (Client Component)
â”‚   â””â”€â”€ Favorite Plans
â”‚       - Up to 5 saved favorites
â”‚       - Remove favorites
â”‚
â””â”€â”€ plan/[id]/page.tsx (Server Component)
    â””â”€â”€ Plan Details
        - Fetch from DB
        - Full plan info
        - Sign up modal
```

### Backend Components (Server-Side)

```
lib/
â”œâ”€â”€ scoring/
â”‚   â”œâ”€â”€ usage-analysis.ts
â”‚   â”‚   â””â”€â”€ analyzeUsage()
â”‚   â”‚       - Pattern detection
â”‚   â”‚       - Statistical analysis
â”‚   â”‚       - Peak identification
â”‚   â”‚
â”‚   â”œâ”€â”€ cost-calculator.ts
â”‚   â”‚   â””â”€â”€ calculatePlanCost()
â”‚   â”‚       - Fixed rate calc
â”‚   â”‚       - Variable rate calc
â”‚   â”‚       - TOU calc (40/60 split)
â”‚   â”‚       - ETF calculation
â”‚   â”‚
â”‚   â”œâ”€â”€ plan-scorer.ts
â”‚   â”‚   â””â”€â”€ scorePlan()
â”‚   â”‚       - Cost score (0-100)
â”‚   â”‚       - Flexibility score
â”‚   â”‚       - Renewable score
â”‚   â”‚       - Rating score
â”‚   â”‚       - Seasonal score (feature-flagged)
â”‚   â”‚       - Weighted combination
â”‚   â”‚
â”‚   â””â”€â”€ plan-ranker.ts
â”‚       â””â”€â”€ filterAndRankPlans()
â”‚           - Filter by constraints
â”‚           - Relax if <5 plans
â”‚           - Sort by score
â”‚           - Return top 5
â”‚
â”œâ”€â”€ anthropic/
â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â””â”€â”€ Claude API client
â”‚   â”‚
â”‚   â”œâ”€â”€ explanations.ts
â”‚   â”‚   â””â”€â”€ generateExplanation()
â”‚   â”‚       - Build prompt
â”‚   â”‚       - Call Claude API
â”‚   â”‚       - Validate response
â”‚   â”‚       - Fallback template
â”‚   â”‚       - Cache results
â”‚   â”‚
â”‚   â””â”€â”€ batch-explanations.ts
â”‚       â””â”€â”€ generateAllExplanations()
â”‚           - Parallel API calls (3x)
â”‚           - Promise.all()
â”‚
â””â”€â”€ database/
    â”œâ”€â”€ client.ts
    â”‚   â””â”€â”€ Prisma singleton
    â”‚
    â””â”€â”€ recs-parser.ts
        â””â”€â”€ Parse test data
```

---

## Data Flow Diagrams

### Flow 1: Complete User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Landing Page                                             â”‚
â”‚ Component: app/page.tsx (Server)                                 â”‚
â”‚ Action: Click "Get Started"                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Navigate to /usage
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Usage Input                                              â”‚
â”‚ Component: app/usage/page.tsx (Client)                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ User Actions:                                                â”‚ â”‚
â”‚ â”‚ - Upload CSV OR manually enter 12 months                     â”‚ â”‚
â”‚ â”‚ - Validate: all positive, < 10,000 kWh                      â”‚ â”‚
â”‚ â”‚                                                               â”‚ â”‚
â”‚ â”‚ Data Storage:                                                 â”‚ â”‚
â”‚ â”‚ sessionStorage.setItem('usageData', JSON.stringify(data))    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Navigate to /preferences
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Preferences                                              â”‚
â”‚ Component: app/preferences/page.tsx (Client)                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ User Actions:                                                â”‚ â”‚
â”‚ â”‚ - Select state (TX, PA, OH, IL)                             â”‚ â”‚
â”‚ â”‚ - Select priority (cost, renewable, flexibility, balanced)   â”‚ â”‚
â”‚ â”‚ - Set advanced filters (sliders)                             â”‚ â”‚
â”‚ â”‚ - Optional: select current plan                              â”‚ â”‚
â”‚ â”‚                                                               â”‚ â”‚
â”‚ â”‚ Data Storage:                                                 â”‚ â”‚
â”‚ â”‚ sessionStorage.setItem('preferences', JSON.stringify(prefs)) â”‚ â”‚
â”‚ â”‚ sessionStorage.setItem('state', state)                       â”‚ â”‚
â”‚ â”‚ sessionStorage.setItem('currentPlan', planId)                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Navigate to /recommendations
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Generate Recommendations (API Call)                      â”‚
â”‚ Component: app/recommendations/page.tsx (Client)                 â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ useEffect on mount:                                          â”‚ â”‚
â”‚ â”‚ 1. Read from sessionStorage                                  â”‚ â”‚
â”‚ â”‚ 2. Build API request                                         â”‚ â”‚
â”‚ â”‚ 3. POST /api/recommendations                                 â”‚ â”‚
â”‚ â”‚ 4. Show loading state                                        â”‚ â”‚
â”‚ â”‚ 5. Display results                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ API Request
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER-SIDE PROCESSING                                           â”‚
â”‚ (See detailed API flow below)                                    â”‚
â”‚ - Fetch plans from DB                                            â”‚
â”‚ - Run scoring algorithm                                          â”‚
â”‚ - Generate AI explanations                                       â”‚
â”‚ - Return top 5 recommendations                                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ API Response
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Display Results                                          â”‚
â”‚ Component: app/recommendations/page.tsx (Client)                 â”‚
â”‚ - Show top 5 cards with explanations                             â”‚
â”‚ - Search, filter, favorites, compare features                     â”‚
â”‚ - "View Details" â†’ /plan/[id]                                    â”‚
â”‚ - "Sign Up" â†’ Modal (MVP limitation)                             â”‚
â”‚ - "Try Different Preferences" â†’ /preferences                     â”‚
â”‚ - "Start Over" â†’ /usage (clear sessionStorage)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Architecture

### Client-Server Boundary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Browser)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  React Components ('use client')                                     â”‚
â”‚  â”œâ”€â”€ usage/page.tsx          [State: usageData]                     â”‚
â”‚  â”œâ”€â”€ preferences/page.tsx     [State: preferences, state]            â”‚
â”‚  â””â”€â”€ recommendations/page.tsx [State: loading, error, recommendations]â”‚
â”‚                                                                       â”‚
â”‚  State Management: useState + sessionStorage                         â”‚
â”‚  Form Validation: Client-side (before API call)                      â”‚
â”‚  API Calls: fetch() to /api/*                                        â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP/HTTPS
                              â”‚ JSON payloads
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVER (Vercel Edge)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  API Routes (Next.js Route Handlers)                                 â”‚
â”‚  â”œâ”€â”€ /api/recommendations/route.ts  [POST]                          â”‚
â”‚  â”œâ”€â”€ /api/plans/route.ts            [GET]                           â”‚
â”‚  â””â”€â”€ /api/plans/[id]/route.ts       [GET]                           â”‚
â”‚                                                                       â”‚
â”‚  Server Components                                                   â”‚
â”‚  â”œâ”€â”€ page.tsx (landing)                                              â”‚
â”‚  â””â”€â”€ plan/[id]/page.tsx (fetches from DB directly)                  â”‚
â”‚                                                                       â”‚
â”‚  Business Logic (Pure Functions)                                     â”‚
â”‚  â”œâ”€â”€ lib/scoring/*         [Scoring algorithms]                     â”‚
â”‚  â”œâ”€â”€ lib/anthropic/*       [AI integration]                         â”‚
â”‚  â””â”€â”€ lib/database/*        [Data access]                            â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Supabase     â”‚  â”‚  Claude API   â”‚
                    â”‚   PostgreSQL   â”‚  â”‚  (Anthropic)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagrams

### Primary Flow: Recommendation Generation

```
CLIENT                          SERVER                       EXTERNAL SERVICES
  â”‚                               â”‚                                â”‚
  â”‚ 1. POST /api/recommendations  â”‚                                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 2. Rate Limit Check            â”‚
  â”‚                               â”‚    (in-memory store)           â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 3. Validate Request (Zod)      â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 4. Query Plans                 â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚    SELECT * FROM plans         â”‚ Supabase
  â”‚                               â”‚    WHERE state = ?             â”‚
  â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚    [20-50 plan records]        â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 5. Analyze Usage               â”‚
  â”‚                               â”‚    - Calculate averages        â”‚
  â”‚                               â”‚    - Detect patterns           â”‚
  â”‚                               â”‚    - Identify peaks            â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 6. Calculate Costs (all plans) â”‚
  â”‚                               â”‚    for (plan of plans) {       â”‚
  â”‚                               â”‚      cost = calculateCost()    â”‚
  â”‚                               â”‚    }                           â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 7. Score Plans                 â”‚
  â”‚                               â”‚    - Cost score                â”‚
  â”‚                               â”‚    - Flexibility score         â”‚
  â”‚                               â”‚    - Renewable score           â”‚
  â”‚                               â”‚    - Rating score              â”‚
  â”‚                               â”‚    - Seasonal score (optional) â”‚
  â”‚                               â”‚    - Weighted sum              â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 8. Rank & Filter               â”‚
  â”‚                               â”‚    - Sort by finalScore        â”‚
  â”‚                               â”‚    - Take top 5                â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 9. Generate Explanations (AI)  â”‚
  â”‚                               â”‚    Promise.all([               â”‚
  â”‚                               â”‚      explain(plan1),  â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚      explain(plan2),  â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Claude API
  â”‚                               â”‚      explain(plan3),  â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ (5 parallel)
  â”‚                               â”‚      explain(plan4),  â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚      explain(plan5)   â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚    ])                          â”‚
  â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚    [5 explanations]            â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 10. Check Cache First          â”‚
  â”‚                               â”‚     (skip API if cached)       â”‚
  â”‚                               â”‚                                â”‚
  â”‚                               â”‚ 11. Build Response             â”‚
  â”‚                               â”‚     - recommendations (3)      â”‚
  â”‚                               â”‚     - metadata                 â”‚
  â”‚                               â”‚     - confidence level         â”‚
  â”‚                               â”‚                                â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                â”‚
  â”‚  JSON Response                â”‚                                â”‚
  â”‚  {                            â”‚                                â”‚
  â”‚    recommendations: [...],    â”‚                                â”‚
  â”‚    metadata: {...}            â”‚                                â”‚
  â”‚  }                            â”‚                                â”‚
  â”‚                               â”‚                                â”‚
  â”‚ 12. Display Results           â”‚                                â”‚
  â”‚     - Render cards            â”‚                                â”‚
  â”‚     - Show explanations       â”‚                                â”‚
  â”‚                               â”‚                                â”‚
```

### Data Flow Metrics

| Step | Processing Time | Bottleneck? |
|------|-----------------|-------------|
| 1-2. Rate limit + validation | <10ms | No |
| 3-4. Database query | 50-100ms | No |
| 5. Usage analysis | <5ms | No |
| 6. Cost calculation (20 plans) | <10ms | No |
| 7. Plan scoring (20 plans) | <10ms | No |
| 8. Ranking | <5ms | No |
| 9. AI explanations (3 calls) | 1-2 seconds | âš ï¸ **Yes** |
| 10. Response serialization | <5ms | No |
| **Total** | **1-2.5 seconds** | Target: <2s |

---

## AI Integration Points

### ðŸ¤– AI Usage: Explanation Generation

#### Where AI is Used

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AI Integration Layer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  lib/anthropic/explanations.ts                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ generateExplanation(context)                         â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ Input Context:                                        â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Plan details (name, rate, contract, etc.)       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ User profile (usage, pattern, priorities)       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Cost breakdown (annual, savings, etc.)          â”‚  â”‚
â”‚  â”‚ â””â”€â”€ Ranking (why this plan? #1, #2, or #3)         â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ Process:                                              â”‚  â”‚
â”‚  â”‚ 1. Check cache (state+planId+rank+priority)         â”‚  â”‚
â”‚  â”‚ 2. If cached â†’ return immediately                    â”‚  â”‚
â”‚  â”‚ 3. If not cached â†’ call Claude API                   â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ AI Prompt Structure:                                  â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ "You are an expert energy plan advisor..."      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ User Profile: [usage, pattern, priorities]      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Recommended Plan: [all details]                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                                                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Why ranked #X? Focus on user priorities.        â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Requirements: 2-3 sentences, specific numbers    â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ API Call:                                             â”‚  â”‚
â”‚  â”‚ - Model: claude-3-5-sonnet-20241022                 â”‚  â”‚
â”‚  â”‚ - Max tokens: 300                                    â”‚  â”‚
â”‚  â”‚ - Timeout: 10 seconds                                â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ Validation:                                           â”‚  â”‚
â”‚  â”‚ - Length: 50-500 chars                               â”‚  â”‚
â”‚  â”‚ - Contains numbers                                    â”‚  â”‚
â”‚  â”‚ - Not generic ("great option")                       â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ Fallback:                                             â”‚  â”‚
â”‚  â”‚ - On error â†’ template-based explanation             â”‚  â”‚
â”‚  â”‚ - On timeout â†’ template-based explanation           â”‚  â”‚
â”‚  â”‚ - On validation failure â†’ template                   â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ Cache Result:                                         â”‚  â”‚
â”‚  â”‚ explanationCache.set(key, explanation)               â”‚  â”‚
â”‚  â”‚ (max 100 entries, LRU eviction)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AI Prompt Example

```
Input to Claude:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You are an expert energy plan advisor. Explain why this     â”‚
â”‚ plan was recommended in 2-3 clear, specific sentences.      â”‚
â”‚                                                              â”‚
â”‚ User Profile:                                                â”‚
â”‚ - Annual usage: 12,000 kWh (1,000 kWh/month average)       â”‚
â”‚ - Usage pattern: summer peak                                 â”‚
â”‚ - Current annual cost: $1,450                               â”‚
â”‚ - Priorities: cost (renewable: 0%+, max contract: 24 mo)    â”‚
â”‚                                                              â”‚
â”‚ Recommended Plan (Rank #1):                                  â”‚
â”‚ - Supplier: Texas GreenPower                                â”‚
â”‚ - Plan: 100% Green 12-Month                                 â”‚
â”‚ - Rate: $0.1199/kWh                                         â”‚
â”‚ - Monthly fee: $9.95                                        â”‚
â”‚ - Contract: 12 months                                        â”‚
â”‚ - Renewable: 100%                                            â”‚
â”‚ - Supplier rating: 4.3/5.0                                  â”‚
â”‚ - Projected annual cost: $1,558.80                          â”‚
â”‚ - Savings: -$108.80/year (more expensive)                   â”‚
â”‚                                                              â”‚
â”‚ Why is this plan ranked #1? Focus on what matters most.     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output from Claude:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ While this plan costs $108.80 more annually, it provides    â”‚
â”‚ 100% renewable energy with a strong 4.3/5.0 supplier rating.â”‚
â”‚ The 12-month contract offers rate stability during your     â”‚
â”‚ summer peak months when your usage spikes to 1,450+ kWh.   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AI Performance Optimization

```
Optimization Strategy:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Caching (Most Important)                        â”‚
â”‚    - Key: state-planId-rank-priority              â”‚
â”‚    - Hit rate: ~70-80% (common plans)             â”‚
â”‚    - Saves: ~$0.03 per cached request             â”‚
â”‚                                                     â”‚
â”‚ 2. Parallel Calls                                  â”‚
â”‚    - Promise.all([explain1, explain2, explain3])  â”‚
â”‚    - Time saved: ~2-3 seconds vs sequential       â”‚
â”‚                                                     â”‚
â”‚ 3. Fallback Templates                              â”‚
â”‚    - On error: 0ms, $0 cost                       â”‚
â”‚    - Quality: Good enough for MVP                  â”‚
â”‚                                                     â”‚
â”‚ 4. Token Limits                                    â”‚
â”‚    - Input: ~400 tokens                            â”‚
â”‚    - Output: max 300 tokens                        â”‚
â”‚    - Cost: ~$0.003 per explanation (3 Ã— $0.001)  â”‚
â”‚                                                     â”‚
â”‚ 5. Timeout Protection                              â”‚
â”‚    - 10 second limit                               â”‚
â”‚    - Prevents hanging requests                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cost per recommendation request:
- No cache hits: 5 explanations Ã— $0.001 = $0.005
- With 70% hit rate: 1.5 explanations Ã— $0.001 = $0.0015
- Fallback (error): $0.000

Expected: 100 requests/day Ã— $0.002 avg = $0.20/day = $6/month
```

---

## Client-Server Interactions

### Interaction Pattern: RESTful API

```
CLIENT ACTIONS                  SERVER RESPONSES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Load Landing Page
   GET /
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 HTML (Server Component)
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 Status: 200

2. Load Usage Page
   GET /usage
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 HTML (Client Component bundle)
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 Status: 200

3. Submit Usage Data
   (No server call - saved to sessionStorage)

4. Load Preferences Page
   GET /preferences
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 HTML (Client Component bundle)
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 Status: 200

5. Submit Preferences
   (No server call - saved to sessionStorage)

6. Get Recommendations
   POST /api/recommendations
   {
     userId: "user-123",
     state: "TX",
     monthlyUsageKwh: [850, ...],
     preferences: {...}
   }
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 Process request:
                                 - Rate limit check
                                 - Validate with Zod
                                 - Query database
                                 - Run algorithms
                                 - Call Claude API (3Ã—)
                                 - Build response
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   {                             Status: 200
     recommendations: [...],     Time: 1-2 seconds
     metadata: {...}
   }

7. View Plan Details
   GET /plan/[id]
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 HTML (Server Component)
                                 - Fetch from DB
                                 - Render page
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 Status: 200

8. Get Plan List (Optional)
   GET /api/plans?state=TX
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                 Query database
                                 Filter by params
   <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   {                             Status: 200
     plans: [...],
     count: 17
   }
```

### Request/Response Contracts

#### POST /api/recommendations

**Request:**
```typescript
{
  userId: string                    // "user-123" (placeholder for MVP)
  state?: 'TX' | 'PA' | 'OH' | 'IL' // Filter plans by state
  monthlyUsageKwh: number[12]       // Exactly 12 months
  currentPlan?: {
    planId: string                  // Plan identifier
    startDate?: string              // ISO date (optional)
    contractEndDate?: string        // ISO date (optional)
  }
  preferences: {
    priority: 'cost' | 'renewable' | 'flexibility' | 'balanced'
    minRenewablePct: number         // 0-100
    maxContractMonths: number       // 1-36
    minSupplierRating: number       // 1.0-5.0
  }
}
```

**Response (Success - 200):**
```typescript
{
  recommendations: [
    {
      rank: 1,
      plan: { /* full plan object */ },
      projectedAnnualCost: 1558.80,
      annualSavings: -108.80,
      explanation: "While this plan costs...", // AI-generated
      score: 87.5,
      breakdown: {
        costScore: 72,
        flexibilityScore: 50,
        renewableScore: 100,
        ratingScore: 86,
        seasonalScore: 60,
        finalScore: 87.5
      }
    },
    // ... 2 more
  ],
  metadata: {
    totalAnnualUsageKwh: 12000,
    usagePattern: 'summer_peak',
    currentPlanAnnualCost: 1450,
    generatedAt: "2025-11-11T...",
    confidence: 'high'
  }
}
```

**Response (Error - 400/429/500):**
```typescript
{
  error: string,              // Human-readable message
  details?: ZodError[]        // Validation details (400 only)
}

Headers (429):
  X-RateLimit-Limit: "10"
  X-RateLimit-Remaining: "0"
  X-RateLimit-Reset: "1699564800000"
```

---

## Database Schema

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Plan                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                    String (cuid)                  â”‚
â”‚ UQ  planId                String                         â”‚
â”‚ IDX state                 String ('TX', 'PA', ...)       â”‚
â”‚ IDX supplierName          String                         â”‚
â”‚     planName              String                         â”‚
â”‚     rateType              String ('fixed', 'variable')   â”‚
â”‚ IDX ratePerKwh            Float                          â”‚
â”‚     monthlyFee            Float                          â”‚
â”‚     contractLengthMonths  Int?                           â”‚
â”‚     earlyTerminationFee   Float                          â”‚
â”‚ IDX renewablePct          Int                            â”‚
â”‚     supplierRating        Float                          â”‚
â”‚     planDetails           Json?                          â”‚
â”‚     createdAt             DateTime                       â”‚
â”‚     updatedAt             DateTime                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                    String (cuid)                  â”‚
â”‚ UQ  email                 String                         â”‚
â”‚     password              String (hashed)                â”‚
â”‚     name                  String?                        â”‚
â”‚     createdAt             DateTime                       â”‚
â”‚     updatedAt             DateTime                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SavedRecommendation                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                    String (cuid)                  â”‚
â”‚ FK  userId                String â†’ User.id              â”‚
â”‚     recommendations       Json (top 5 plans)            â”‚
â”‚     monthlyUsageKwh       Int[] (12 months)              â”‚
â”‚     preferences           Json                           â”‚
â”‚     state                 String                         â”‚
â”‚     createdAt             DateTime                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SavedUsageData                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                    String (cuid)                  â”‚
â”‚ FK  userId                String â†’ User.id              â”‚
â”‚     monthlyKwh            Int[] (12 months)              â”‚
â”‚     state                 String                         â”‚
â”‚     createdAt             DateTime                       â”‚
â”‚     updatedAt             DateTime                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Note: Users can save recommendations and usage data
      (last 5 recommendation sets per user)
```

### Database Queries

```sql
-- Most common query (Recommendations API)
SELECT * FROM plans 
WHERE state = 'TX'
  AND renewablePct >= 0
  AND contractLengthMonths <= 24
  AND supplierRating >= 3.0
ORDER BY supplierRating DESC;

-- Indexes support:
-- 1. state (primary filter)
-- 2. renewablePct (common constraint)
-- 3. ratePerKwh (cost comparisons)
-- 4. supplierName (plan lookups)

-- Query performance: <100ms for 20-50 plans
```

---

## API Architecture

### API Route Organization

```
app/api/
â”œâ”€â”€ recommendations/
â”‚   â””â”€â”€ route.ts                    [POST]
â”‚       - Rate limiting (10 req/min, Vercel KV)
â”‚       - Request validation (Zod)
â”‚       - Main recommendation logic
â”‚       - AI explanation generation
â”‚       - Response: Top 5 recommendations
â”‚
â””â”€â”€ plans/
    â”œâ”€â”€ route.ts                    [GET]
    â”‚   - List all plans (with filters)
    â”‚   - Query params: state, minRenewable, maxContract, etc.
    â”‚   - Response: Plan array
    â”‚
    â””â”€â”€ [id]/
        â””â”€â”€ route.ts                [GET]
            - Get single plan by ID
            - Response: Plan object or 404
```

### API Processing Flow (Recommendations)

```
Request arrives
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. RATE LIMITING                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Check: IP address                             â”‚    â”‚
â”‚    â”‚ Limit: 10 requests per 60 seconds            â”‚    â”‚
â”‚    â”‚ Store: Vercel KV (prod) or in-memory (dev)   â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ If exceeded:                                  â”‚    â”‚
â”‚    â”‚   return 429 Too Many Requests               â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ PASS
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. INPUT VALIDATION (Zod Schema)                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Validate:                                     â”‚    â”‚
â”‚    â”‚ - userId: string âœ“                           â”‚    â”‚
â”‚    â”‚ - state: enum âœ“                              â”‚    â”‚
â”‚    â”‚ - monthlyUsageKwh: array[12] of numbers âœ“   â”‚    â”‚
â”‚    â”‚ - preferences: object with constraints âœ“     â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ If invalid:                                   â”‚    â”‚
â”‚    â”‚   return 400 Bad Request + error details    â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ VALID
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. DATABASE QUERY (Prisma + Supabase)                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Query: prisma.plan.findMany({                â”‚    â”‚
â”‚    â”‚   where: { state: validatedData.state }      â”‚    â”‚
â”‚    â”‚ })                                            â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ Returns: 15-20 plan records for state        â”‚    â”‚
â”‚    â”‚ Time: 50-100ms                               â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ If empty:                                     â”‚    â”‚
â”‚    â”‚   return 503 Service Unavailable             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ PLANS FETCHED
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BUSINESS LOGIC (Pure Functions)                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ a) analyzeUsage(monthlyUsageKwh)             â”‚    â”‚
â”‚    â”‚    - Calculate averages, median              â”‚    â”‚
â”‚    â”‚    - Detect pattern (summer/winter/flat)     â”‚    â”‚
â”‚    â”‚    - Identify peak months                    â”‚    â”‚
â”‚    â”‚    Time: <5ms                                â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ b) calculatePlanCost(plan, usage, ...)       â”‚    â”‚
â”‚    â”‚    - For each plan (20Ã—):                    â”‚    â”‚
â”‚    â”‚      * Calculate energy charges              â”‚    â”‚
â”‚    â”‚      * Add monthly fees                      â”‚    â”‚
â”‚    â”‚      * Add switching costs (if applicable)   â”‚    â”‚
â”‚    â”‚    Time: <10ms total                         â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ c) scorePlan(plan, cost, preferences, ...)   â”‚    â”‚
â”‚    â”‚    - For each plan (20Ã—):                    â”‚
â”‚    â”‚      * Cost score (0-100)                    â”‚    â”‚
â”‚    â”‚      * Flexibility score (0-100)             â”‚    â”‚
â”‚    â”‚      * Renewable score (0-100)               â”‚    â”‚
â”‚    â”‚      * Rating score (0-100)                  â”‚    â”‚
â”‚    â”‚      * Seasonal score (0-100, optional)      â”‚    â”‚
â”‚    â”‚      * Weighted sum â†’ finalScore             â”‚    â”‚
â”‚    â”‚    Time: <10ms total                         â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ d) filterAndRankPlans(...)                   â”‚    â”‚
â”‚    â”‚    - Filter by constraints                   â”‚    â”‚
â”‚    â”‚    - Relax if <5 matches                     â”‚    â”‚
â”‚    â”‚    - Sort by finalScore DESC                 â”‚    â”‚
â”‚    â”‚    - Return top 5                            â”‚    â”‚
â”‚    â”‚    Time: <5ms                                â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ TOP 5 PLANS
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. AI EXPLANATION GENERATION (Anthropic Claude)         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ ðŸ¤– For each of top 5 plans (parallel):       â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ generateExplanationWithCache(context)        â”‚    â”‚
â”‚    â”‚ â”œâ”€ Check cache first                         â”‚    â”‚
â”‚    â”‚ â”‚  â””â”€ If hit: return cached (0ms)           â”‚    â”‚
â”‚    â”‚ â”‚                                             â”‚    â”‚
â”‚    â”‚ â””â”€ If miss: Call Claude API                  â”‚    â”‚
â”‚    â”‚    â”œâ”€ Build prompt (400 tokens)              â”‚    â”‚
â”‚    â”‚    â”œâ”€ API call (with 10s timeout)            â”‚    â”‚
â”‚    â”‚    â”œâ”€ Validate response                      â”‚    â”‚
â”‚    â”‚    â”œâ”€ Cache result                           â”‚    â”‚
â”‚    â”‚    â””â”€ Return explanation                     â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ Time: 500ms-2s per call (parallel)          â”‚    â”‚
â”‚    â”‚ Total: 1-2 seconds for all 5                â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ Error handling:                               â”‚    â”‚
â”‚    â”‚ - Timeout â†’ Use template                     â”‚    â”‚
â”‚    â”‚ - API error â†’ Use template                   â”‚    â”‚
â”‚    â”‚ - Invalid â†’ Use template                     â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ EXPLANATIONS READY
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RESPONSE CONSTRUCTION                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Build RecommendationResponse:                â”‚    â”‚
â”‚    â”‚ - Map scored plans to recommendations        â”‚    â”‚
â”‚    â”‚ - Attach AI explanations                     â”‚    â”‚
â”‚    â”‚ - Calculate confidence level                 â”‚    â”‚
â”‚    â”‚ - Add metadata                               â”‚    â”‚
â”‚    â”‚                                               â”‚    â”‚
â”‚    â”‚ Serialize to JSON                            â”‚    â”‚
â”‚    â”‚ Time: <5ms                                   â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Response sent to client
Status: 200 OK
Content-Type: application/json
Total time: 1-2.5 seconds
```

### State Management Pattern

```
CLIENT STATE FLOW:

sessionStorage (Persistent Across Pages)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key             â”‚ Value Type                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usageData       â”‚ number[] (12 months)     â”‚
â”‚ preferences     â”‚ UserPreferences object   â”‚
â”‚ state           â”‚ 'TX' | 'PA' | 'OH' | 'IL'â”‚
â”‚ currentPlan     â”‚ string (planId)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Component State (React useState)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page            â”‚ Local State              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usage/page      â”‚ - usageData (temp)       â”‚
â”‚                 â”‚ - errors                 â”‚
â”‚                 â”‚                          â”‚
â”‚ preferences/    â”‚ - preferences (temp)     â”‚
â”‚ page            â”‚ - state (temp)           â”‚
â”‚                 â”‚ - currentPlan (temp)     â”‚
â”‚                 â”‚                          â”‚
â”‚ recommendations/â”‚ - loading                â”‚
â”‚ page            â”‚ - error                  â”‚
â”‚                 â”‚ - recommendations        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Data Flow Between Pages:
usage/page.tsx
    â”‚ sessionStorage.setItem('usageData', ...)
    â–¼
preferences/page.tsx
    â”‚ sessionStorage.getItem('usageData')
    â”‚ sessionStorage.setItem('preferences', ...)
    â”‚ sessionStorage.setItem('state', ...)
    â–¼
recommendations/page.tsx
    â”‚ sessionStorage.getItem('usageData')
    â”‚ sessionStorage.getItem('preferences')
    â”‚ sessionStorage.getItem('state')
    â–¼
API call with combined data
```

---

## Detailed Process Flows

### Scoring Algorithm Flow

```
Input: Plan, Usage, Preferences, All Costs
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NORMALIZE COST SCORE (0-100)                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ maxCost = max(allCosts.map(c => c.firstYearTotal)) â”‚   â”‚
â”‚ â”‚ costScore = 100 Ã— (1 - thisCost/maxCost)           â”‚   â”‚
â”‚ â”‚                                                      â”‚   â”‚
â”‚ â”‚ Example:                                             â”‚   â”‚
â”‚ â”‚ - Plan A: $1200/yr â†’ score: 100 (cheapest)         â”‚   â”‚
â”‚ â”‚ - Plan B: $1400/yr â†’ score: 85.7                   â”‚   â”‚
â”‚ â”‚ - Plan C: $1800/yr â†’ score: 33.3 (most expensive)  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLEXIBILITY SCORE (0-100)                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Based on contract length:                          â”‚   â”‚
â”‚ â”‚ - Month-to-month: 100                              â”‚   â”‚
â”‚ â”‚ - â‰¤6 months: 70                                    â”‚   â”‚
â”‚ â”‚ - â‰¤12 months: 50                                   â”‚   â”‚
â”‚ â”‚ - â‰¤24 months: 30                                   â”‚   â”‚
â”‚ â”‚ - >24 months: 10                                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RENEWABLE SCORE (0-100)                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Direct mapping:                                    â”‚   â”‚
â”‚ â”‚ renewableScore = renewablePct                      â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ - 100% renewable â†’ 100                             â”‚   â”‚
â”‚ â”‚ - 50% renewable â†’ 50                               â”‚   â”‚
â”‚ â”‚ - 0% renewable â†’ 0                                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUPPLIER RATING SCORE (0-100)                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ratingScore = (supplierRating / 5.0) Ã— 100         â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ - 5.0/5.0 â†’ 100                                    â”‚   â”‚
â”‚ â”‚ - 4.0/5.0 â†’ 80                                     â”‚   â”‚
â”‚ â”‚ - 3.0/5.0 â†’ 60                                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEASONAL FIT SCORE (0-100) [Feature-Flagged]             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ If ENABLE_SEASONAL_SCORING = false:                â”‚   â”‚
â”‚ â”‚   return 50 (neutral)                              â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ If enabled, based on rateType Ã— usagePattern:     â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚ â”‚ â”‚ TOU + summer_peak â†’ 75                     â”‚    â”‚   â”‚
â”‚ â”‚ â”‚ TOU + winter_peak â†’ 40                     â”‚    â”‚   â”‚
â”‚ â”‚ â”‚ Fixed (any pattern) â†’ 60                   â”‚    â”‚   â”‚
â”‚ â”‚ â”‚ Variable + peak â†’ 40                       â”‚    â”‚   â”‚
â”‚ â”‚ â”‚ Variable + flat â†’ 55                       â”‚    â”‚   â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WEIGHTED COMBINATION                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Get weights based on user priority:               â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ if priority = 'cost':                              â”‚   â”‚
â”‚ â”‚   weights = {                                      â”‚   â”‚
â”‚ â”‚     cost: 0.60, flexibility: 0.10,                â”‚   â”‚
â”‚ â”‚     renewable: 0.10, rating: 0.10, seasonal: 0.10 â”‚   â”‚
â”‚ â”‚   }                                                â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ if priority = 'renewable':                         â”‚   â”‚
â”‚ â”‚   weights = { renewable: 0.50, cost: 0.30, ... }  â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ finalScore =                                       â”‚   â”‚
â”‚ â”‚   (costScore Ã— weights.cost) +                    â”‚   â”‚
â”‚ â”‚   (flexScore Ã— weights.flexibility) +             â”‚   â”‚
â”‚ â”‚   (renewScore Ã— weights.renewable) +              â”‚   â”‚
â”‚ â”‚   (ratingScore Ã— weights.rating) +                â”‚   â”‚
â”‚ â”‚   (seasonalScore Ã— weights.seasonal)              â”‚   â”‚
â”‚ â”‚                                                     â”‚   â”‚
â”‚ â”‚ Example:                                           â”‚   â”‚
â”‚ â”‚ - Cost priority: 60% weight on cost score         â”‚   â”‚
â”‚ â”‚ - Renewable priority: 50% weight on renewable     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
   Return ScoreBreakdown
   {
     costScore: 85.7,
     flexibilityScore: 50,
     renewableScore: 100,
     ratingScore: 86,
     seasonalScore: 60,
     finalScore: 87.5
   }
```

### AI Explanation Generation Flow

```
Input: Top 5 Scored Plans
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FOR EACH PLAN (Parallel Processing)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Plan #1              Plan #2              Plan #3          â”‚
â”‚     â”‚                    â”‚                    â”‚             â”‚
â”‚     â–¼                    â–¼                    â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Build Cache Key                                    â”‚  â”‚
â”‚  â”‚    key = `${state}-${planId}-${rank}-${priority}`   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. Check Cache                                        â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
â”‚  â”‚    â”‚ Cache Hit? â”‚ YES â†’ Return cached explanation     â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚
â”‚  â”‚         â”‚ NO                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3. Build AI Prompt                                    â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚    â”‚ Context includes:                             â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - User profile (usage, pattern, priorities)  â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Plan details (rate, fees, contract)        â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Cost breakdown (annual, savings)           â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Ranking position (#1, #2, #3)              â”‚  â”‚  â”‚
â”‚  â”‚    â”‚                                               â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ Prompt structure:                             â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ "You are an expert energy plan advisor...    â”‚  â”‚  â”‚
â”‚  â”‚    â”‚  User Profile: [...]                          â”‚  â”‚  â”‚
â”‚  â”‚    â”‚  Recommended Plan: [...]                      â”‚  â”‚  â”‚
â”‚  â”‚    â”‚  Why ranked #X? Be specific."                â”‚  â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 4. Call Claude API ðŸ¤–                                 â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚    â”‚ anthropic.messages.create({                   â”‚  â”‚  â”‚
â”‚  â”‚    â”‚   model: 'claude-3-5-sonnet-20241022',       â”‚  â”‚  â”‚
â”‚  â”‚    â”‚   max_tokens: 300,                            â”‚  â”‚  â”‚
â”‚  â”‚    â”‚   messages: [{ role: 'user', content }],     â”‚  â”‚  â”‚
â”‚  â”‚    â”‚   signal: abortSignal // 10s timeout         â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ })                                            â”‚  â”‚  â”‚
â”‚  â”‚    â”‚                                               â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ Response time: 500ms-2s                      â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ Cost: ~$0.001 per call                       â”‚  â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 5. Validate Response                                  â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚    â”‚ Checks:                                       â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Length: 50-500 chars âœ“                     â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Contains numbers âœ“                         â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ - Not generic âœ“                              â”‚  â”‚  â”‚
â”‚  â”‚    â”‚                                               â”‚  â”‚  â”‚
â”‚  â”‚    â”‚ If invalid â†’ Use fallback template           â”‚  â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 6. Cache Result                                       â”‚  â”‚
â”‚  â”‚    explanationCache.set(key, explanation)            â”‚  â”‚
â”‚  â”‚    (Check size limit: 100 max, LRU eviction)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  Promise.all() waits for all 5 to complete                 â”‚
â”‚  Total time: ~1-2 seconds (parallel)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Return [explanation1, explanation2, explanation3, explanation4, explanation5]
```

---

## AI Integration Points

### ðŸ¤– AI Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AI INTEGRATION LAYER                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Anthropic Claude API Wrapper                           â”‚    â”‚
â”‚  â”‚  (lib/anthropic/)                                       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  Client    â”‚   â”‚ Explanations â”‚   â”‚    Batch     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  Setup     â”‚â”€â”€>â”‚  Generator   â”‚â”€â”€>â”‚  Processing  â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                    â”‚         â”‚    â”‚
â”‚  â”‚       â”‚                  â–¼                    â–¼         â”‚    â”‚
â”‚  â”‚       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚       â”‚          â”‚    Prompt    â”‚    â”‚ Parallel API â”‚ â”‚    â”‚
â”‚  â”‚       â”‚          â”‚   Builder    â”‚    â”‚    Calls     â”‚ â”‚    â”‚
â”‚  â”‚       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                    â”‚         â”‚    â”‚
â”‚  â”‚       â–¼                  â–¼                    â–¼         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚           Cache Layer (In-Memory)              â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  - Key: state-planId-rank-priority             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  - Max size: 100 entries (LRU)                 â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  - Hit rate: ~70-80%                           â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚                         â”‚                               â”‚    â”‚
â”‚  â”‚                         â–¼                               â”‚    â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚    â”‚
â”‚  â”‚              â”‚  Fallback Templates â”‚                    â”‚    â”‚
â”‚  â”‚              â”‚  (on error/timeout) â”‚                    â”‚    â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Anthropic API      â”‚
                    â”‚   (External Service) â”‚
                    â”‚                      â”‚
                    â”‚   Endpoint:          â”‚
                    â”‚   api.anthropic.com  â”‚
                    â”‚                      â”‚
                    â”‚   Model:             â”‚
                    â”‚   claude-3-5-sonnet  â”‚
                    â”‚   -20241022          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AI Prompt Engineering

**Prompt Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTEM CONTEXT                                            â”‚
â”‚ "You are an expert energy plan advisor..."                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER PROFILE DATA                                         â”‚
â”‚ - Annual usage: 12,000 kWh                               â”‚
â”‚ - Monthly average: 1,000 kWh                             â”‚
â”‚ - Usage pattern: summer_peak                             â”‚
â”‚ - Current cost: $1,450/year                              â”‚
â”‚ - Priorities: cost (renewable: 0%+, contract: â‰¤24mo)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RECOMMENDED PLAN DETAILS                                  â”‚
â”‚ - Supplier: Texas GreenPower                             â”‚
â”‚ - Plan: 100% Green 12-Month                              â”‚
â”‚ - Rate: $0.1199/kWh                                      â”‚
â”‚ - Monthly fee: $9.95                                     â”‚
â”‚ - Contract: 12 months                                     â”‚
â”‚ - Renewable: 100%                                         â”‚
â”‚ - Rating: 4.3/5.0                                        â”‚
â”‚ - Projected cost: $1,558.80/year                         â”‚
â”‚ - Savings: -$108.80/year (more expensive)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPECIFIC QUESTION                                         â”‚
â”‚ "Why is this plan ranked #1?"                            â”‚
â”‚ "Focus on what matters most based on their priorities."  â”‚
â”‚ "Be specific with numbers. Mention one trade-off."       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONSTRAINTS & REQUIREMENTS                                â”‚
â”‚ - 2-3 sentences maximum                                  â”‚
â”‚ - Include specific dollar amounts                         â”‚
â”‚ - Use "you" and "your" (direct address)                  â”‚
â”‚ - No marketing fluff, just facts                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**AI Response Processing:**
```
Claude API Response
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extract text content   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   FAIL   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate explanation   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Use fallback        â”‚
â”‚ - Length OK?           â”‚          â”‚ template            â”‚
â”‚ - Has numbers?         â”‚          â”‚ (deterministic)     â”‚
â”‚ - Not generic?         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ PASS
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return explanation     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Client-Server Interactions

### Interaction Pattern 1: Server Components (No JS)

```
USER REQUEST                    SERVER PROCESSING
    â”‚                                â”‚
    â”‚ GET /                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚ 1. Render React component
    â”‚                                â”‚ 2. Generate HTML
    â”‚                                â”‚ 3. Send to client
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   HTML (no JavaScript needed)  â”‚
    â”‚                                â”‚
    
Example: Landing page (app/page.tsx)
- No client-side state
- Pure HTML/CSS
- Fast first paint
- SEO friendly
```

### Interaction Pattern 2: Client Components (Hydrated)

```
USER REQUEST                    SERVER PROCESSING
    â”‚                                â”‚
    â”‚ GET /usage                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚ 1. Send HTML shell
    â”‚                                â”‚ 2. Send React bundle
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   HTML + JavaScript            â”‚
    â”‚                                â”‚
    â”‚ (Client-side hydration)        â”‚
    â”‚                                â”‚
    â”‚ User enters data               â”‚
    â”‚ Form validation                â”‚
    â”‚ Save to sessionStorage         â”‚
    â”‚ (All happens client-side)      â”‚
    â”‚                                â”‚

Example: Usage input (app/usage/page.tsx)
- Interactive form
- Client-side state
- No server roundtrips
- sessionStorage persistence
```

### Interaction Pattern 3: API Routes

```
CLIENT                          API ROUTE                    SERVICES
  â”‚                               â”‚                             â”‚
  â”‚ POST /api/recommendations     â”‚                             â”‚
  â”‚ {                             â”‚                             â”‚
  â”‚   userId: "...",              â”‚                             â”‚
  â”‚   state: "TX",                â”‚                             â”‚
  â”‚   monthlyUsageKwh: [...],     â”‚                             â”‚
  â”‚   preferences: {...}          â”‚                             â”‚
  â”‚ }                             â”‚                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”‚ Rate limit                  â”‚
  â”‚                               â”‚ Validate                    â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”‚ Query DB                    â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚   Prisma â†’ Supabase         â”‚
  â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚   Plans data                â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”‚ Run algorithms              â”‚
  â”‚                               â”‚ (pure functions)            â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”‚ Generate explanations       â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚   Call Claude API (5Ã—)      â”‚
  â”‚                               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚   Explanations              â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”‚ Build response              â”‚
  â”‚                               â”‚                             â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
  â”‚ {                             â”‚                             â”‚
  â”‚   recommendations: [...],     â”‚                             â”‚
  â”‚   metadata: {...}             â”‚                             â”‚
  â”‚ }                             â”‚                             â”‚
  â”‚                               â”‚                             â”‚
```

### Data Transfer Sizes

```
Request/Response Sizes:

POST /api/recommendations
  Request:  ~0.5 KB  (12 numbers + preferences)
  Response: ~8-15 KB (5 plans + explanations)

GET /api/plans
  Request:  ~0.1 KB  (query params)
  Response: ~10-20 KB (20-50 plans)

GET /plan/[id] (Server Component)
  Request:  ~0.1 KB  (URL param)
  Response: ~2-3 KB  (HTML page)

Total data transfer per user session: ~15-30 KB
```

---

## Database Schema

### Prisma Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Plan                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Field                  Type      Constraints              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                     String    @id @default(cuid())    â”‚
â”‚ planId                 String    @unique                 â”‚
â”‚ state                  String    indexed                 â”‚
â”‚ supplierName           String    indexed                 â”‚
â”‚ planName               String                            â”‚
â”‚ rateType               String    'fixed'|'variable'|'tou'â”‚
â”‚ ratePerKwh             Float     indexed                 â”‚
â”‚ monthlyFee             Float     default(0)              â”‚
â”‚ contractLengthMonths   Int?      nullable                â”‚
â”‚ earlyTerminationFee    Float     default(0)              â”‚
â”‚ renewablePct           Int       indexed (0-100)         â”‚
â”‚ supplierRating         Float     (1.0-5.0)               â”‚
â”‚ planDetails            Json?     nullable                â”‚
â”‚ createdAt              DateTime  auto                    â”‚
â”‚ updatedAt              DateTime  auto                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Indexes:
- state (for filtering by geography)
- renewablePct (common user constraint)
- ratePerKwh (cost sorting)
- supplierName (plan lookups)

Query patterns:
WHERE state = ? AND renewablePct >= ? AND contractLengthMonths <= ?
```

### Data Access Patterns

```
Read-Heavy Workload:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query                  â”‚ Frequency     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ findMany (state)       â”‚ Every request â”‚
â”‚ findUnique (id)        â”‚ Occasional    â”‚
â”‚ findMany (filters)     â”‚ Rare          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Write Operations:
- Seed: One-time (or infrequent manual updates)
- No user writes to Plans table
- No recommendation history stored (MVP)

Connection Pool:
- Prisma manages automatically
- Supabase free tier: 60 connections
- Expected usage: 1-2 concurrent
```

---

## Error Handling Flows

### Error Flow 1: Validation Error

```
Client sends invalid data
     â”‚
     â–¼
API Route: POST /api/recommendations
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Zod validation fails     â”‚
â”‚ - Only 11 months?        â”‚
â”‚ - Invalid state?         â”‚
â”‚ - Missing preferences?   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Catch ZodError           â”‚
â”‚ Extract error details    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return 400 Bad Request   â”‚
â”‚ {                        â”‚
â”‚   error: "Invalid data", â”‚
â”‚   details: [...]         â”‚
â”‚ }                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Client displays error message
"CSV must contain exactly 12 months of data"
```

### Error Flow 2: Rate Limit Exceeded

```
Client makes 11th request in 1 minute
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rate limit check         â”‚
â”‚ - Count: 11              â”‚
â”‚ - Limit: 10              â”‚
â”‚ - Exceeded!              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return 429 Too Many      â”‚
â”‚ {                        â”‚
â”‚   error: "Too many..."   â”‚
â”‚ }                        â”‚
â”‚ Headers:                 â”‚
â”‚   X-RateLimit-Reset: ... â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Client handles 429
"Too many requests. Please wait a moment."
```

### Error Flow 3: AI Timeout

```
AI call takes >10 seconds
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AbortController triggers â”‚
â”‚ after 10s timeout        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Catch AbortError         â”‚
â”‚ Log: "LLM timeout"       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Use fallback template:   â”‚
â”‚ "This plan can save you  â”‚
â”‚  $X/year with Y%         â”‚
â”‚  renewable energy..."    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Continue processing
(User never knows AI failed)
```

### Error Flow 4: No Plans Available

```
User selects PA, but no PA plans in DB
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query returns empty []   â”‚
â”‚ allPlans.length === 0    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return 503 Service       â”‚
â”‚ {                        â”‚
â”‚   error: "No plans       â”‚
â”‚   available for PA. Try  â”‚
â”‚   different state."      â”‚
â”‚ }                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
Client displays helpful error
+ "Try selecting Texas instead"
```

---

## Performance Architecture

### Critical Path Analysis

```
User clicks "Get Recommendations"
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRITICAL PATH (Target: <2 seconds)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚ 1. API Request Overhead              10ms            â”‚
â”‚    â””â”€ Network latency                               â”‚
â”‚                                                       â”‚
â”‚ 2. Rate Limiting                     <5ms            â”‚
â”‚    â””â”€ Vercel KV (prod) or in-memory (dev)          â”‚
â”‚                                                       â”‚
â”‚ 3. Request Validation                5ms             â”‚
â”‚    â””â”€ Zod schema parsing                            â”‚
â”‚                                                       â”‚
â”‚ 4. Database Query                    50-100ms        â”‚
â”‚    â””â”€ Supabase SELECT (indexed)                     â”‚
â”‚                                                       â”‚
â”‚ 5. Usage Analysis                    <5ms            â”‚
â”‚    â””â”€ Array operations                              â”‚
â”‚                                                       â”‚
â”‚ 6. Cost Calculations (20 plans)     10ms            â”‚
â”‚    â””â”€ 20Ã— simple math                               â”‚
â”‚                                                       â”‚
â”‚ 7. Plan Scoring (20 plans)           10ms            â”‚
â”‚    â””â”€ 20Ã— weighted sums                             â”‚
â”‚                                                       â”‚
â”‚ 8. Ranking & Filtering               5ms             â”‚
â”‚    â””â”€ Array sort + slice                            â”‚
â”‚                                                       â”‚
â”‚ 9. AI Explanations (BOTTLENECK)      1-2 seconds âš ï¸ â”‚
â”‚    â””â”€ 5Ã— parallel Claude API calls                  â”‚
â”‚    â””â”€ Cache hit: 0ms (70% of time)                 â”‚
â”‚                                                       â”‚
â”‚ 10. Response Serialization           <5ms            â”‚
â”‚     â””â”€ JSON.stringify                               â”‚
â”‚                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL: 1.1-2.2 seconds (avg: 1.5s)                  â”‚
â”‚ 95th percentile: <2s (meets target)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Optimization opportunities:
1. âœ… Cache AI responses (70-80% hit rate)
2. âœ… Parallel AI calls (saves 1-2s vs sequential)
3. âš ï¸ Pre-compute plan costs (for static catalog)
4. âš ï¸ Use Claude Haiku (faster, cheaper, but lower quality)
```

### Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CACHING LAYERS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚ 1. LLM Response Cache (LRU, In-Memory)                  â”‚
â”‚    Location: lib/anthropic/explanations.ts              â”‚
â”‚    Key: state-planId-rank-priority                      â”‚
â”‚    TTL: Infinite (cleared on restart)                   â”‚
â”‚    Size: Max 100 entries (LRU eviction)                 â”‚
â”‚    Hit rate: 70-80%                                     â”‚
â”‚                                                           â”‚
â”‚ 2. Rate Limit Cache (Vercel KV or In-Memory)           â”‚
â”‚    Location: lib/rate-limit.ts                          â”‚
â”‚    Key: IP address                                      â”‚
â”‚    TTL: 60 seconds                                      â”‚
â”‚    Production: Vercel KV (distributed)                  â”‚
â”‚    Development: In-memory (cleaned every 5 min)        â”‚
â”‚                                                           â”‚
â”‚ 3. Next.js Page Cache (CDN)                             â”‚
â”‚    - Static pages: Cached at edge                       â”‚
â”‚    - Dynamic pages: Not cached                          â”‚
â”‚    - API routes: Not cached                             â”‚
â”‚                                                           â”‚
â”‚ 4. Database Connection Pool (Prisma)                    â”‚
â”‚    - Reuses connections                                 â”‚
â”‚    - Managed automatically                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Post-MVP caching opportunities:
- âœ… Vercel KV for distributed rate limiting (implemented)
- Redis for LLM response cache (shared across instances)
- Pre-computed plan costs (materialized view)
```

---

## Security Architecture

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT-SIDE SECURITY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Form validation (Zod on client)                       â”‚
â”‚ - Input sanitization (before sessionStorage)            â”‚
â”‚ - No sensitive data in sessionStorage                   â”‚
â”‚ - HTTPS only (enforced by Vercel)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TRANSPORT SECURITY                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - TLS 1.3 (automatic via Vercel)                        â”‚
â”‚ - Certificate: Let's Encrypt (auto-renewed)            â”‚
â”‚ - CORS: Next.js default (same-origin)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVER-SIDE SECURITY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Rate limiting (10 req/min per IP)                     â”‚
â”‚ - Input validation (Zod schema)                         â”‚
â”‚ - SQL injection prevention (Prisma)                     â”‚
â”‚ - Environment variables (server-only)                   â”‚
â”‚   * ANTHROPIC_API_KEY (never exposed to client)        â”‚
â”‚   * DATABASE_URL (server-only)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DATABASE SECURITY                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Connection string encryption (Supabase)               â”‚
â”‚ - Row-level security (Supabase, not used in MVP)       â”‚
â”‚ - SSL connections (required)                            â”‚
â”‚ - Prepared statements (Prisma)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. API KEY SECURITY                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Anthropic API key (server-side only)                  â”‚
â”‚ - Supabase anon key (public, RLS-protected)            â”‚
â”‚ - No keys in git (.env.local in .gitignore)            â”‚
â”‚ - Vercel environment variables (encrypted)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture

### Vercel Serverless Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       VERCEL EDGE NETWORK                    â”‚
â”‚                     (Global CDN + Functions)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  US East     â”‚  â”‚   US West    â”‚  â”‚   Europe     â”‚      â”‚
â”‚  â”‚  (Primary)   â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚  Edge Function â”‚                        â”‚
â”‚                    â”‚  (API Routes)  â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                            â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     Supabase             â”‚
              â”‚  (US East - Primary)     â”‚
              â”‚                          â”‚
              â”‚  PostgreSQL Database     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Function lifecycle:
1. Cold start: 200-500ms (first request)
2. Warm: <50ms overhead
3. Timeout: 10 seconds max (Vercel free tier)
4. Memory: 1024 MB
5. Concurrent: Up to 10 (free tier)
```

---

## Summary

### Key Architectural Decisions

| Decision | Rationale | Trade-off |
|----------|-----------|-----------|
| **Full-stack Next.js** | Single codebase, type safety | Limited backend flexibility |
| **Server Components** | Fast initial load, SEO | Less interactivity |
| **Client Components for forms** | Rich UX, validation | Larger bundle |
| **sessionStorage** | Simple, no DB writes | Lost on close tab |
| **Serverless (Vercel)** | Zero ops, auto-scale | Cold starts, stateless |
| **Supabase PostgreSQL** | Managed, free tier | Vendor lock-in |
| **Prisma ORM** | Type safety, great DX | Abstraction layer |
| **Claude API** | Best explanations | Cost, latency |
| **In-memory cache** | Simple, fast | Not distributed |
| **No authentication (MVP)** | Faster to ship | No personalization |

### AI Value Proposition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Without AI:                                               â”‚
â”‚ - Generic template explanations                          â”‚
â”‚ - Same text for every user                               â”‚
â”‚ - No contextual reasoning                                â”‚
â”‚ - Low trust/understanding                                â”‚
â”‚                                                           â”‚
â”‚ With AI:                                                  â”‚
â”‚ âœ“ Personalized explanations                              â”‚
â”‚ âœ“ Context-aware (usage pattern, priorities)             â”‚
â”‚ âœ“ Specific numbers and trade-offs                       â”‚
â”‚ âœ“ Natural language (not formulaic)                      â”‚
â”‚ âœ“ Builds trust and confidence                           â”‚
â”‚                                                           â”‚
â”‚ Cost: ~$0.001-0.003 per recommendation                   â”‚
â”‚ Value: 20% conversion uplift, 30% fewer support tickets  â”‚
â”‚ ROI: High (user acquisition cost >> $0.003)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow Summary

1. **User Input** â†’ sessionStorage (client-side)
2. **Preferences** â†’ sessionStorage (client-side)
3. **API Request** â†’ Server validates & processes
4. **Database Query** â†’ Fetch plans (Supabase)
5. **Algorithms** â†’ Score and rank (server CPU)
6. **AI Generation** â†’ Explain top 5 (Claude API)
7. **Response** â†’ Client displays results
8. **Plan Details** â†’ Server-rendered page

**Total round trips:** 1-2 per user session
**AI calls:** 5 per recommendation (parallelized)
**Database queries:** 1-2 per session

---

**Document Version:** 1.0  
**Last Updated:** November 11, 2025  
**Companion Documents:** Implementation_PRD.md, Implementation_Tasks.md

