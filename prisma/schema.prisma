// This is your Prisma schema file
// Energy Plan Recommender

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id                   String   @id @default(cuid())
  planId               String   @unique
  state                String
  supplierName         String
  planName             String
  rateType             String   // 'fixed', 'variable', 'tou'
  ratePerKwh           Float
  onPeakRate           Float?   // For TOU plans
  offPeakRate          Float?   // For TOU plans
  monthlyFee           Float    @default(0)
  contractLengthMonths Int?     // null for month-to-month
  earlyTerminationFee  Float    @default(0)
  renewablePct         Int      // 0-100
  supplierRating       Float    // 1.0-5.0
  planDetails          Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([state])
  @@index([renewablePct])
  @@index([ratePerKwh])
  @@index([supplierName])
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  password              String                 // Hashed
  name                  String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  savedUsageData        SavedUsageData[]
  savedRecommendations  SavedRecommendation[]
  currentPlan           UserCurrentPlan?
}

model SavedUsageData {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthlyKwh Json     // Array of 12 numbers
  state      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model SavedRecommendation {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendations Json     // Full recommendation response
  monthlyUsageKwh Json     // Array of 12 numbers for reference
  preferences     Json     // User preferences used
  state           String
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
}

model RecommendationRating {
  id              String   @id @default(cuid())
  
  // User identification (anonymous or authenticated)
  userId          String?  // null for anonymous users
  sessionId       String?  // For anonymous users
  
  // Recommendation details
  recommendationId String  // ID of the recommendation (can be plan ID or custom)
  planId          String   // Plan that was rated
  rank            Int      // Rank of the recommendation (1-5)
  
  // Rating
  rating          Int      // 1-5 stars, or -1 (thumbs down), 1 (thumbs up)
  ratingType      String   // 'star' | 'thumbs'
  
  // Optional feedback
  feedback        String?  // Optional text feedback
  helpful         Boolean? // Was this recommendation helpful?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([planId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

model UserCurrentPlan {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan identification
  planId            String?  // If plan exists in our database
  supplierName      String
  planName          String
  
  // Rate details
  ratePerKwh        Float
  rateType          String   // 'fixed', 'variable', 'tou'
  onPeakRate        Float?
  offPeakRate       Float?
  monthlyFee        Float    @default(0)
  
  // Contract details
  contractStartDate DateTime
  contractEndDate   DateTime?
  contractLengthMonths Int?
  earlyTerminationFee Float  @default(0)
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}
